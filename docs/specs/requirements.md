# 要件定義書

## 概要

VSCode上でGitHub Discussionsを効率的に閲覧・編集・管理できる拡張機能。開発者がIDEを離れることなく、プロジェクトのDiscussionsに参加し、コミュニティとのやり取りを行えるようにする。

## 用語集

- **拡張機能**: VSCode拡張機能
- **GitHub_API**: GitHub GraphQL/REST API
- **Discussion**: GitHubリポジトリのDiscussion機能で作成される議論スレッド
- **コメント**: Discussionに対するコメント
- **カテゴリ**: Discussionのカテゴリ（Q&A、General、Ideas等）
- **ツリービュー**: VSCodeのサイドバーに表示される階層表示UI
- **Webビュー**: VSCode内でHTMLコンテンツを表示するパネル
- **認証サービス**: GitHub認証を管理するサービス

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、VSCodeの組み込みGitHub認証を使用したい。そうすることで、現在開いているリポジトリのDiscussionsに既存の権限でアクセスできるようになる。

#### 受け入れ基準

1. 拡張機能が読み込まれたとき、拡張機能はVSCodeの組み込みGitHub認証プロバイダーを使用する
2. ユーザーがGitHubにサインインしていない場合、拡張機能はVSCodeの認証フローを促す
3. 認証が成功したとき、拡張機能は現在のセッションでアクセストークンを取得する
4. 認証が失敗したとき、拡張機能はエラーメッセージを表示し、VSCodeの認証設定への案内を提供する
5. 拡張機能はVSCodeの認証状態の変更を監視し、自動的に状態を更新する

### 要件2

**ユーザーストーリー:** 開発者として、現在のリポジトリのDiscussions一覧を表示したい。そうすることで、どのようなトピックが議論されているかを確認できる。

#### 受け入れ基準

1. 拡張機能が読み込まれ、ユーザーが認証済みのとき、拡張機能は現在のGitリポジトリを検出する
2. 有効なGitHubリポジトリが検出されたとき、拡張機能はGitHub_APIを使用してDiscussionsのメタデータ（タイトル、番号、カテゴリ、作成者、日時等）のみを取得する（本文・コメントは除く）
3. Discussionsが正常に取得されたとき、ツリービューはそれらをカテゴリ別に整理して表示する
4. Discussionsが存在しないとき、ツリービューは適切な空の状態メッセージを表示する
5. APIリクエストが失敗したとき、拡張機能はエラー情報を表示し、再試行オプションを提供する

### 要件3

**ユーザーストーリー:** 開発者として、Discussionの詳細を読み、編集したい。そうすることで、VSCodeの標準エディタ機能を使って会話の全体的な文脈を理解し、編集できる。

#### 受け入れ基準

1. ユーザーがツリービューでDiscussionをクリックしたとき、拡張機能はGitHub_APIを使用してDiscussionの詳細（本文）を取得し、Virtual File Systemを使用してマークダウン編集タブを開く（遅延読み込み）
2. マークダウン編集タブはDiscussionの本文を表示し、VSCodeの標準エディタ機能（シンタックスハイライト、プレビュー等）を使用できる
3. ユーザーがファイルを保存したとき、拡張機能はGitHub_API経由でDiscussion本文を更新する
4. 更新が成功したとき、拡張機能はDiscussions一覧を更新し、変更を反映する
5. 更新が失敗したとき、拡張機能はエラーメッセージを表示し、ファイルを未保存状態に戻す

### 要件4

**ユーザーストーリー:** 開発者として、新しいDiscussionを作成したい。そうすることで、VSCodeの標準エディタ機能を使ってプロジェクトについての会話を開始できる。

#### 受け入れ基準

1. ユーザーがDiscussion作成ボタンをクリックしたとき、拡張機能はVirtual File Systemを使用して新しいマークダウンファイルを開く
2. 新しいファイルには、タイトル、カテゴリ、本文を記述するためのテンプレートが含まれる
3. ユーザーがファイルを保存したとき、拡張機能はファイル内容を解析してGitHub_API経由でDiscussionを作成する
4. 作成が成功したとき、拡張機能はDiscussions一覧を更新し、新しいDiscussionを表示する
5. 作成が失敗したとき、拡張機能はエラーメッセージを表示し、ファイルを未保存状態に戻す

### 要件5

**ユーザーストーリー:** 開発者として、Discussionsのコメントを閲覧し、返信したい。そうすることで、会話に参加できる。

#### 受け入れ基準

1. ツリービューの各Discussion項目の右側にコメントアイコンを表示する
2. ユーザーがコメントアイコンをクリックしたとき、拡張機能はコメント一覧と返信機能を持つWebビューを別タブで開く
3. Webビューはコメントを時系列順で表示し、スレッド形式の返信も表示する
4. Webビューは下部にコメント入力エリアを提供し、ユーザーがコメントを入力して送信できる
5. ユーザーがコメントを送信したとき、拡張機能はGitHub_API経由でそれを投稿する
6. コメントが正常に投稿されたとき、Webビューは新しいコメントを即座に表示するよう更新する
7. コメント投稿が失敗したとき、拡張機能はエラーメッセージを表示する
8. 拡張機能はプレビュー機能付きのマークダウンフォーマットをコメント入力でサポートする
9. コンテンツにマークダウンが含まれているとき、Webビューはシンタックスハイライト付きで適切にレンダリングする
10. 各コメントにリプライボタンを表示し、クリックするとそのコメントへの返信入力フォームが展開される
11. ユーザーがリプライを送信したとき、拡張機能はGitHub_API経由でコメントへの返信として投稿する
12. リプライが正常に投稿されたとき、Webビューは親コメントの下にリプライを即座に表示するよう更新する
13. リプライはインデント付きで親コメントの下に階層的に表示される

### 要件6

**ユーザーストーリー:** 開発者として、自分のDiscussionsとコメントを編集したい。そうすることで、VSCodeの標準エディタ機能を使って間違いを修正したり情報を更新したりできる。

#### 受け入れ基準

1. 現在のユーザーが作成したDiscussionを表示しているとき、Webビューは編集ボタンを表示する
2. ユーザーが編集ボタンをクリックしたとき、拡張機能はVirtual File Systemを使用してDiscussionをマークダウンファイルとして開く
3. Virtual File Systemで開かれたファイルを保存したとき、拡張機能はGitHub_API経由で変更をDiscussionに反映する
4. 編集が正常に保存されたとき、拡張機能はWebビューとツリービューを更新して変更を反映する
5. 編集操作が失敗したとき、拡張機能は適切なエラーメッセージを表示し、ファイルを未保存状態に戻す

### 要件7

**ユーザーストーリー:** 開発者として、拡張機能がDiscussionsを自動的に更新してほしい。そうすることで、手動操作なしに更新を確認できる。

#### 受け入れ基準

1. 拡張機能は設定可能な自動更新間隔設定を提供する
2. 自動更新が有効なとき、拡張機能は定期的に更新されたDiscussionsを取得する
3. 新しいDiscussionsやコメントが検出されたとき、拡張機能はツリービューを自動的に更新する
4. ユーザーがDiscussionを積極的に表示しているとき、拡張機能はWebビューコンテンツを更新する
5. 拡張機能は即座の更新のための手動更新コントロールを提供する

### 要件8

**ユーザーストーリー:** 開発者として、Discussionsを検索・フィルタしたい。そうすることで、関連する会話を素早く見つけることができる。

#### 受け入れ基準

1. ツリービューは上部に検索入力フィールドを提供する
2. ユーザーが検索語を入力したとき、拡張機能はタイトルとコンテンツでDiscussionsをフィルタする
3. 拡張機能はカテゴリベースのフィルタリングオプションを提供する
4. フィルタが適用されたとき、ツリービューは一致するDiscussionsのみを表示する
5. 検索・フィルタ語がクリアされたとき、ツリービューは全てのDiscussionsを再び表示する

### 要件9

**ユーザーストーリー:** 開発者として、コードベースの品質を維持したい。そうすることで、保守性と拡張性の高いコードを維持できる。

#### 受け入れ基準

1. 重複したコードは共通のユーティリティ関数やサービスに抽出される
2. キャッシング戦略は一貫性のある単一のサービスで管理される
3. エラーハンドリングパターンは統一され、再利用可能である
4. 不要なコードや未使用の依存関係は削除される
5. クラス間の依存関係は明確で、循環参照がない

### 要件10

**ユーザーストーリー:** 開発者として、コメントWebViewをモダンなUIで閲覧したい。そうすることで、視覚的に見やすく、使いやすいコメント閲覧体験ができる。

#### 受け入れ基準

1. コメントカードにはシャドウ（box-shadow）を使用した立体感のあるデザインを適用する
2. コメントカードにホバー時の浮き上がりエフェクトを適用する
3. カードの角は丸みを帯び、視覚的に柔らかい印象を与える
4. 作者にはバッジ（「OP」など）を表示し、ディスカッション作成者を識別しやすくする
5. タイムスタンプは相対表示（「3時間前」「昨日」など）で表示する
6. スレッド形式の返信表示を採用し、親子関係を視覚的に明確にする
7. 長いコメントは折りたたみ可能（「続きを読む」）にする
8. ヘッダーはスクロール時にスティッキー（固定）表示される
9. タイポグラフィを改善し、見出しサイズ、行間、文字間隔を最適化する

### 要件11

**ユーザーストーリー:** 開発者として、大量のコメントがあるDiscussionでも全てのコメントを閲覧したい。そうすることで、長い議論の全体を把握できる。

#### 受け入れ基準

1. コメントは100件ずつページングして取得する
2. コメントの返信（replies）も100件ずつページングして取得する
3. 追加のコメントがある場合、「さらに読み込む」ボタンを表示する
4. 「さらに読み込む」ボタンをクリックすると、次の100件を取得して表示に追加する
5. 全てのコメントを読み込み終えた場合、「さらに読み込む」ボタンは非表示になる
6. ページング情報（hasNextPage、endCursor）はAPIレスポンスから取得する
7. 読み込み中は適切なローディング表示を行う

### 要件12

**ユーザーストーリー:** 開発者として、コメント内のMermaid図をレンダリングして表示したい。そうすることで、アーキテクチャ図やフローチャートを視覚的に理解できる。

#### 受け入れ基準

1. コメントWebview内でMermaidコードブロック（```mermaid）を検出し、図としてレンダリングする
2. Mermaid.jsは拡張機能内にバンドルして同梱する（CDNから読み込まない）
3. CSPはnonce属性を使用し、バンドルされたスクリプトのみ許可する
4. Mermaidの初期化はsecurityLevel: 'strict'で行い、XSS攻撃を防止する
5. レンダリングエラー時は元のコードブロックをそのまま表示し、エラーメッセージを表示する
6. 対応するMermaid図の種類: flowchart、sequence、class、state、er、gantt、pie、mindmap

### 要件13

**ユーザーストーリー:** 開発者として、自分が投稿したコメントを編集・削除したい。そうすることで、間違いを修正したり、不要になったコメントを削除したりできる。

#### 受け入れ基準

1. 自分が投稿したコメントにのみ、編集ボタンと削除ボタンを表示する
2. 編集ボタンをクリックすると、コメント本文がテキストエリアに展開され、インラインで編集可能になる
3. 編集中に「保存」ボタンをクリックすると、GitHub_API経由でコメントを更新する
4. 編集中に「キャンセル」ボタンをクリックすると、元のコメント表示に戻る
5. 削除ボタンをクリックすると、確認ダイアログを表示する
6. 確認後、GitHub_API経由でコメントを削除する
7. コメントの更新・削除が成功したとき、Webビューを即座に更新して変更を反映する
8. コメントの更新・削除が失敗したとき、エラーメッセージを表示する
9. 返信（リプライ）に対しても同様に編集・削除機能を提供する

